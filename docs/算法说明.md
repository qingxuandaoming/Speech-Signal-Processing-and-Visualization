# 算法说明

## 预加重（Pre-emphasis）

为提升高频分量、减少直流漂移，以一阶 FIR 形式处理：

$$
y[n] = x[n] - \alpha\, x[n-1], \quad 0<\alpha<1,\; \alpha=0.97
$$

## 分帧与加窗（Framing & Windowing）

- 帧长：`FRAME_DURATION=20ms` → $N=320$
- 帧移：$H=160$（50% 重叠）
- 汉明窗：

$$
w(n) = 0.54 - 0.46\cos\left(\frac{2\pi n}{N-1}\right),\quad 0\le n < N
$$

## 参数与默认值（Config）

为保证文档与实现一致，以下为核心参数的默认取值（来自 `real_time_voice_processing/config.py`）：

- `SAMPLE_RATE=16000`
- `FRAME_SIZE=320`，`HOP_SIZE=160`，窗类型：`hamming`
- `PREEMPHASIS_ALPHA=0.97`
- `ENERGY_THRESHOLD=1000`
- `ZCR_THRESHOLD=0.25`
- `SPECTRAL_ENTROPY_VOICE_MAX=0.45`
- 自适应 VAD：`ADAPTIVE_VAD_ENERGY_K=3.0`，`ADAPTIVE_VAD_ZCR_K=1.0`，历史最少帧数 `ADAPTIVE_VAD_HISTORY_MIN=20`
- 自动阈值校准：`AUTO_CALIBRATE_THRESHOLDS=True`，`CALIBRATION_FRAMES=200`

注：在 UI 中可切换是否使用自适应 VAD 与自动校准，运行时会动态加载配置。

## 短时能量（Short-Time Energy, STE）

反映短时间内信号能量，常用于端点检测：

$$
E(i) = \sum_{n=0}^{N-1} x_i(n)^2
$$

## 过零率（Zero-Crossing Rate, ZCR）

描述单位时间内过零次数，常用于区分清音与浊音：

$$
\mathrm{ZCR}(i) = \frac{1}{2N} \sum_{n=0}^{N-1} \left|\operatorname{sign}(x_i(n)) - \operatorname{sign}(x_i(n+1))\right|
$$

实现备注：

- 可选的去直流步骤为：$x_i \leftarrow x_i - \operatorname{mean}(x_i)$，可在噪声较强或设备存在直流偏置时提升鲁棒性。
- 当前代码实现使用 `np.sign` 与 `np.diff` 统计过零次数，未做显式去直流；与文档公式一致。示例实现：

```python
import numpy as np

def calculate_zero_crossing_rate(frame: np.ndarray) -> float:
    signs = np.sign(frame)
    crossings = np.sum(np.abs(np.diff(signs)) > 0)
    return crossings / frame.size
```

## 短时自相关（Short-Time Autocorrelation, ACF）

用于基音周期检测与周期性分析：

$$
R_i(\tau) = \sum_{n=0}^{N-1-\tau} x_i(n)\,x_i(n+\tau),\quad 0\le \tau < N
$$

归一化：

$$
\hat{R}_i(\tau) = \frac{R_i(\tau)}{\max_{\tau} R_i(\tau)}
$$

## 平均幅度差（Average Magnitude Difference Function, AMDF）

用于基音检测的另一指标：

$$
\mathrm{AMDF}_i(\tau) = \frac{1}{N-\tau} \sum_{n=0}^{N-1-\tau} \left|x_i(n) - x_i(n+\tau)\right|
$$

## 语音活动检测（Voice Activity Detection, VAD）

基于能量与过零率的双门限联合判决（典型有声段为“高能量 + 低 ZCR”）：

$$
\mathrm{VAD}(i) = \begin{cases}
1, & E(i) > T_E \;\land\; \mathrm{ZCR}(i) < T_Z \\
0, & \text{otherwise}
\end{cases}
$$

其中默认阈值取自 `Config`：$T_E=1000$，$T_Z=0.25$。应根据采集设备与环境噪声做适配性调节。

### 自适应 VAD（Adaptive VAD）

在环境噪声非平稳或设备差异较大时，固定阈值容易失效。采用稳健统计估计进行自适应阈值设定：

设历史能量序列 $\{E_k\}$ 与历史过零率序列 $\{Z_k\}$，定义中位数 $m_E=\operatorname{median}(\{E_k\})$ 与中位绝对偏差 $\operatorname{MAD}_E=\operatorname{median}(|E_k-m_E|)$，类似地得到 $m_Z$ 与 $\operatorname{MAD}_Z$。则自适应阈值：

$$
T_E^{\mathrm{adpt}} = m_E + k_E\, \operatorname{MAD}_E,\quad
T_Z^{\mathrm{adpt}} = m_Z + k_Z\, \operatorname{MAD}_Z
$$

联合判决（在能量门控成立下，同时考虑典型有声段与擦音/摩擦音）：

$$
\mathrm{VAD}_{\mathrm{adpt}}(i) = \begin{cases}
1, & E(i) > T_E^{\mathrm{adpt}} \;\land\; \big(\mathrm{ZCR}(i) < T_Z^{\mathrm{adpt}} - \delta_Z \;\;\text{或}\;\; \mathrm{ZCR}(i) > T_Z^{\mathrm{adpt}} + \delta_Z\big) \\
0, & \text{otherwise}
\end{cases}

其中 $\delta_Z$ 为过零率的判别裕量，用于抑制阈值附近抖动；实现中还引入攻击/保持/释放机制以减少误报与粘连。
$$

其中 $k_E,k_Z$ 为调节系数（默认 `Config.ADAPTIVE_VAD_ENERGY_K=3.0`, `Config.ADAPTIVE_VAD_ZCR_K=1.0`）。当历史长度不足时，回退到固定阈值。

### 运行时引擎中的联合门控与平滑

- 联合门控：运行时在能量门控成立（$E(i) > T_E$ 或 $E(i) > T_E^{\mathrm{adpt}}$）的前提下，综合使用过零率与谱熵两条判据：
  - ZCR 判据：$\mathrm{ZCR}(i) < T_Z$（固定）或与自适应判据结合（见上文）。
  - 谱熵判据：$\hat{H}(i) < T_H$，其中默认 `T_H = 0.45`（取自 `SPECTRAL_ENTROPY_VOICE_MAX`）。
  - 实际决策以 `(ZCR 判据) \lor (谱熵判据)` 作为能量门控后的次级判据，提高对擦音/摩擦音与噪声的区分能力。
- 平滑机制：引入攻击（attack）、保持（hold）、释放（release）以抑制抖动与短暂误判。该机制在 `runtime/engine.py` 的处理线程中实现，对帧级决策进行时间上的平滑。
- 自动阈值校准：若开启 `AUTO_CALIBRATE_THRESHOLDS=True`，系统将采集前 `CALIBRATION_FRAMES=200` 帧估计噪声底，自动设定能量与 ZCR 的基础阈值；当 UI 中关闭该选项时，回退到静态/自适应配置。

---

## 频域特征（Spectral Features）

### 谱熵（Spectral Entropy）

谱熵衡量频谱能量分布的均匀程度。给定功率谱 $P(\omega)$，归一化得到概率分布 $p_i = P_i/\sum_j P_j$，谱熵定义为：

$$
H = -\sum_i p_i \ln p_i
$$

常对 $H$ 进行归一化：$\hat{H}=H/\ln M$，其中 $M$ 为谱 bin 数（与实现一致，采用自然对数）。纯音（单峰）具有较低谱熵，白噪声（近均匀分布）具有较高谱熵。

### MFCC（Mel 频率倒谱系数）

MFCC 是语音识别与分析中最常用的频域特征之一，计算流程：

1. 预加重（可选）：$y[n] = x[n] - \alpha x[n-1]$
2. 加窗并做功率谱：$|X(\omega)|^2$
3. Mel 滤波器组（$M$ 个三角滤波器）加权：$E_m = \sum_k |X_k|^2\, H_m(k)$
4. 对数能量：$\log E_m$
5. DCT-II：$c_n = \sum_{m=0}^{M-1} \log E_m \cos\left[\frac{\pi}{M} n\left(m+\tfrac{1}{2}\right)\right]$, 取前 $N_c$ 个系数
6. 升力（可选）：$\tilde{c}_n = c_n\left(1 + \frac{L}{2}\sin\frac{\pi n}{L}\right)$

实现参数：`NUM_MFCC=13`，`MFCC_N_FFT=512`，`MEL_FILTERS=26`，`MFCC_LIFTER=22`。滤波器组的锚点在 Mel 频率上均匀分布，后映射到 Hz 并对应到 FFT bin。

---

## 实现细节与复杂度

- STE/ZCR：$\mathcal{O}(N)$
- ACF（直接法）：$\mathcal{O}(N^2)$，可用 FFT 进行卷积加速至 $\mathcal{O}(N\log N)$
- AMDF：$\mathcal{O}(N^2)$

- 谱熵：$\mathcal{O}(K)$（$K$ 为 FFT 半谱长度）
- MFCC：$\mathcal{O}(K\cdot M)$（$M$ 为滤波器数量；DCT 约 $\mathcal{O}(M\cdot N_c)$）

建议对 ACF/AMDF 的最大延迟 $\tau_{\max}$ 进行约束以控制复杂度。

## 参考

- Rabiner & Schafer, Digital Speech Processing
- 胡航等, 语音信号处理（第三版）
- Unpingco, Python for Signal Processing
- Huang et al., Spoken Language Processing
  