# 架构说明

## 总览

- 架构风格：多线程、生产者-消费者模式
- 主流程：音频采集 → 特征计算 → 结果缓冲 → 可视化展示

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   音频采集线程   │    │   信号处理线程   │    │   可视化线程    │
│  (Producer)     │───>│  (Consumer)     │───>│  (Consumer)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 模块说明

- `AudioRuntime`（`runtime/engine.py`）
  - 负责线程创建与数据流转：`start()` / `stop()`
  - 采集线程：使用 `PyAudio` 读取音频块，写入 `audio_buffer`
  - 处理线程：分帧（重叠）、加窗、计算能量与过零率，进行 VAD 判决，写入 `processed_data`
  - 数据接口：`get_recent_audio()`、`get_recent_processed()`、`save_data()`

- `SignalProcessing`（`signal_processing/` 子包）
  - 预处理：预加重（`alpha=0.97`）、分帧与加窗
  - 时域特征：短时能量（STE）、过零率（ZCR）、短时自相关（ACF）、平均幅度差（AMDF）
  - 频域特征：Mel 滤波器、MFCC、谱熵
  - 窗函数：Hamming / Hanning / Rectangular
  - VAD：固定阈值与自适应阈值

- `VisualizationUI`（`ui/visualization.py`）
  - 基于 `PyQtGraph` 的实时可视化
  - 显示：音频波形、能量、过零率、VAD 结果
  - 控件：开始、停止、保存数据

## 数据流

```
麦克风 → PyAudio → 音频块（`chunk`） → audio_buffer →
overlap_buffer（重叠拼接） → 分帧（`FRAME_SIZE`, `HOP_SIZE`） →
加窗（`WINDOW_TYPE`） → 特征提取（STE/ZCR/ACF/AMDF） → VAD → processed_data → UI 展示
```

## 关键参数（`Config`）

- 音频：`SAMPLE_RATE=16000`、`CHANNELS=1`、`CHUNK_SIZE=1024`
- 帧参数：`FRAME_DURATION=20ms` → `FRAME_SIZE=320`、`HOP_SIZE=160`
- 阈值：`ENERGY_THRESHOLD=1000`、`ZCR_THRESHOLD=0.1`
- 缓冲：`AUDIO_BUFFER_SIZE=4`、`PROCESSED_DATA_BUFFER_SIZE=100`
- 可视化：`PLOT_UPDATE_INTERVAL=50ms`、`WAVEFORM_DISPLAY_LENGTH=4096`

## 线程生命周期（伪代码）

```text
start():
  is_running = True
  spawn(audio_capture_thread)
  spawn(signal_processing_thread)

audio_capture_thread:
  while is_running:
    data = stream.read(chunk)
    audio_buffer.append(np.frombuffer(data, dtype=int16))

signal_processing_thread:
  overlap = []
  while is_running:
    if audio_buffer.empty(): sleep(THREAD_SLEEP_TIME); continue
    overlap += audio_buffer.pop_left()
    while len(overlap) >= FRAME_SIZE:
      frame = overlap[:FRAME_SIZE]
      overlap = overlap[HOP_SIZE:]
      windowed = frame * hamming(FRAME_SIZE)
      E = STE(windowed); Z = ZCR(windowed)
      vad = (E>ENERGY_THRESHOLD and Z>ZCR_THRESHOLD)
      processed_data.append({E,Z,vad})
```

## 扩展点

- 算法扩展：MFCC、谱熵、谱质心等频域特征
- VAD 改进：自适应阈值、统计建模或深度学习方法
- 可视化增强：参数滑块、历史数据保存与回放

## 性能与稳定性建议

- 优先向量化与减少 Python 循环
- 合理设置缓冲区与线程休眠时间，避免音频丢帧
- 通过 `pytest` 的单元测试保障算法正确性
  
## 包结构示意图

```text
real_time_voice_processing/
├── main.py                  # 入口文件（调用 runtime 与 ui）
├── signal_processing/       # 信号处理算法子包（模块化实现）
│   ├── __init__.py          # 聚合类 SignalProcessing（兼容旧 API）
│   ├── windows.py           # 窗函数
│   ├── preprocessing.py     # 预加重与分帧
│   ├── time_features.py     # 时域特征
│   ├── frequency_features.py# 频域特征（Mel、MFCC、谱熵）
│   └── vad.py               # 固定/自适应 VAD
├── config.py                # 配置文件
├── runtime/
│   └── engine.py            # 运行时音频采集与处理（线程控制）
├── ui/
│   └── visualization.py     # 可视化界面与交互控件
├── tests/
│   └── test_signal_processing.py  # 基于 pytest 的算法单元测试
├── docs/
│   ├── 开发指南.md                # 开发与贡献指南
│   ├── 架构说明.md                # 系统架构与数据流程
│   ├── 算法说明.md                # 公式与算法细节（LaTeX）
│   └── 常见问题.md                # FAQ 与故障排除
├── README.md                # 项目说明文档
└── requirements.txt         # 依赖包列表
```
  